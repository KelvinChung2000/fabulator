# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

FABulator is a VS Code extension for visualizing and exploring FPGA fabrics generated by the FABulous framework. It provides interactive fabric visualization using Pixi.js and React, allowing users to load geometry CSV files and FASM bitstream configurations.

## Build and Development Commands

### Core Development
- `npm run compile` - Compile TypeScript extension code
- `npm run watch` - Watch mode for extension development
- `npm run build:webview` - Build React webview UI with Vite
- `npm run build:all` - Build both extension and webview (use before publishing)
- `npm run dev:webview` - Start Vite dev server for webview UI development

### Testing and Quality
- `npm run test` - Run VS Code extension tests
- `npm run test:unit` - Run unit tests with Vitest
- `npm run test:webview` - Run webview-specific tests
- `npm run test:all` - Run all test suites
- `npm run test:coverage` - Generate test coverage report
- `npm run lint` - Run ESLint on source code

### Development Workflow
1. **Extension Development**: Press `F5` in VS Code to launch Extension Development Host
2. **Webview Development**: Use `npm run dev:webview` for hot reload during UI development
3. **Production Build**: Use `npm run build:all` before testing final builds

## Architecture Overview

### Dual-Environment Architecture
The extension operates in two distinct environments:
- **Extension Host**: Node.js environment running TypeScript code (`src/`)
- **Webview**: Browser environment running React + Pixi.js (`src/webview/ui/`)
- **Communication**: Message passing via VS Code Webview API

### Core Components
- **Extension Entry**: `src/extension.ts` - Main extension activation and commands
- **Webview Provider**: `src/webview/FabricWebviewProvider.ts` - Manages webview lifecycle
- **Parsers**: `src/parsers/` - GeometryParser (CSV) and FasmParser (FASM files)
- **UI Components**: `src/webview/ui/src/` - React-based user interface
- **Fabric Renderer**: `src/webview/ui/src/fabric/FabricRenderer.ts` - Pixi.js visualization engine

### Key Architectural Patterns

#### Message-Driven Architecture
Extension and webview communicate via messages:
```typescript
// Extension → Webview
webview.postMessage({ type: 'loadFabric', data: geometryData });

// Webview → Extension  
vscode.postMessage({ type: 'tileClick', data: { tileName, x, y } });
```

#### Parser-Renderer Pipeline
1. **File Selection**: VS Code file dialogs
2. **Parsing**: TypeScript parsers convert CSV/FASM to objects
3. **Serialization**: Maps converted to objects for JSON transfer
4. **Rendering**: Pixi.js creates interactive visualizations

#### Level of Detail (LOD) System
Fabric renderer implements 3-tier LOD similar to original JavaFX:
- **LOW (0.15x)**: Show only low-LOD rectangles for BELs
- **MEDIUM (0.5x)**: Show low-LOD wire substitutes
- **HIGH (1.7x+)**: Show all details including ports

### Package Structure
- `src/extension.ts` - Extension activation and command registration
- `src/parsers/` - File format parsers (geometry CSV, FASM)
- `src/types/` - Shared TypeScript type definitions
- `src/webview/` - Webview provider and utilities
- `src/webview/ui/src/` - React application
- `src/webview/ui/src/components/` - React components (FabricViewer, ZoomControls, WorldView)
- `src/webview/ui/src/fabric/` - Pixi.js rendering engine
- `tests/` - Test files and fixtures

### Core Dependencies
- **VS Code API** - Extension host integration
- **TypeScript** - Type-safe development
- **React 18** - UI framework for webview
- **Pixi.js 8** - WebGL/Canvas graphics rendering
- **pixi-viewport** - Pan/zoom viewport management
- **Vite** - Fast build system for webview UI
- **Vitest** - Testing framework

## Important Development Notes

### Webview Development Considerations
- Use development mode (`npm run dev:webview`) for hot reload
- Webview has strict Content Security Policy - use nonce for scripts
- Test in both development (Vite dev server) and production (built assets) modes
- Canvas/WebGL initialization can fail - implement fallback rendering

### File Format Support
- **Geometry**: CSV files with fabric structure (tiles, BELs, wires, switch matrices)
- **Design**: FASM files with bitstream configurations and net connectivity
- Both parsers handle malformed data gracefully with validation

### Testing Strategy
- **Extension Tests**: VS Code test runner for command and integration testing
- **Unit Tests**: Vitest for parser logic and utilities
- **Webview Tests**: Separate Vitest config with jsdom for React components
- **Real Data Testing**: Uses production eFPGA geometry (16×10, 470KB) for validation

### Performance Considerations
- Viewport culling for large fabrics (160+ tiles)
- LOD system reduces rendering complexity at low zoom
- WebGL preferred, Canvas fallback available
- Tested with production-scale fabrics (3018×4770 pixels)

### Memory Management
- Containers implement destruction patterns
- Viewport and renderer properly cleaned up on webview disposal
- Graphics objects reused where possible to avoid GC pressure

## VS Code Integration

### Commands
- `fabulator.openFabric` - Open geometry CSV file
- `fabulator.openDesign` - Open FASM design file  
- `fabulator.selectFabricFile` - Select fabric file from sidebar
- `fabulator.refreshSidebar` - Refresh sidebar contents
- `fabulator.highlightElement` - Highlight element in viewer from sidebar
- `fabulator.helloWorld` - Test command

### Sidebar (Activity Bar)
The extension provides a dedicated **FABulator** sidebar in the VS Code Activity Bar with the following panels:

#### Search Panel
- **Real-time search** across all fabric elements (tiles, BELs, ports, wires, nets)
- **Debounced input** with 300ms delay for performance
- **Search tips** and usage guidance
- **Clear search** functionality

#### Fabric Explorer
- **Hierarchical tree view** of loaded fabric and design data
- **File selection** button to load geometry CSV files
- **Fabric information** section showing dimensions and tile counts
- **Tiles section** with searchable list of all fabric tiles
- **Tile Types section** showing detailed tile type definitions including:
  - BELs (Basic Elements) with ports
  - Switch matrices with ports and jump ports  
  - Wire geometries and routing paths
- **Design section** (when FASM file loaded) showing:
  - Design statistics (nets, connections, used tiles)
  - Nets with connection details
  - Interactive net exploration

#### Interactive Features
- **Click-to-navigate**: Click any element in sidebar to highlight and pan to it in main viewer
- **Context menus**: Right-click elements for additional actions
- **Expandable tree**: Drill down into tile types, BELs, switch matrices, etc.
- **Search integration**: Search results update tree view in real-time
- **Element highlighting**: Sidebar selections automatically highlight in 3D viewer

### UI Integration
- **Standalone sidebar** with dedicated activity bar icon (circuit-board)
- **Webview panel** in main editor area for 3D visualization
- **Bidirectional communication** between sidebar and main viewer
- **File dialogs** with appropriate filters
- **Status messages** and error handling via VS Code APIs
- **Keyboard shortcuts** for zoom controls (Ctrl/Cmd + +/-/0/1)

The extension successfully bridges the JavaFX-based FABulator desktop application to VS Code, maintaining core visualization capabilities while leveraging modern web technologies.